name: Deploy Reflex to GitHub Pages

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install reflex
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Initialize Reflex
        run: reflex init

      - name: Export Static Site
        run: reflex export --frontend-only --no-zip

      # --- AQUÃ ESTÃ LA MAGIA (El Rastreador) ---
      - name: Find and Prepare Deploy
        run: |
          # 1. Buscar dÃ³nde se generÃ³ el index.html (ignora node_modules)
          BUILD_PATH=$(find . -name index.html -not -path "*/node_modules/*" -printf "%h\n" | head -n 1)
          
          echo "âœ… Web encontrada en: $BUILD_PATH"
          
          # 2. Crear una carpeta limpia para el despliegue
          mkdir -p public_html
          
          # 3. Copiar TODO el contenido de la web a la carpeta limpia
          cp -r "$BUILD_PATH"/* public_html/
          
          # 4. Crear el CNAME ahÃ­ mismo
          echo "quickenglish.academy" > public_html/CNAME
          
          # 5. Listar para confirmar (esto saldrÃ¡ en el log si algo falla)
          echo "ðŸ“‚ Contenido listo para subir:"
          ls -R public_html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public_html  # Subimos la carpeta limpia que acabamos de llenar
          force_orphan: true        # Esto limpia el historial de la rama gh-pages para evitar conflictos